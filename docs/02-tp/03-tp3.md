import CodeBlock from '@theme/CodeBlock';
import CommentCommitPush from '/comment-commit-push.mdx';

# TP3 : MessageBoard

## Consignes (15% de la note finale)
- Lisez toutes les instructions et la grille de correction avant de commencer
- Vous **DEVEZ** faire au moins les migrations et les commits demandés mais vous pouvez en faire plus sans problème, tant que vous les documentez correctement

A faire pour prof:
- Comment ca fonctionne si le user a encore son token? https://stackoverflow.com/questions/14448604/using-razor-how-do-i-render-a-boolean-to-a-javascript-variable
- Verifier que le banissement fonctionne bien
- Afficher le username et non le email dans le menu de login
- Ajouter/modifier des unit tests avec Moq
- Faire une grille de correction (Est-ce possible de faire des points si on bloque quelque pars? Eviter que ce soit un TP 1 ou 0!!)
- Corriger les dates des messages? (rentrer une date fixe)
- Unit tests: Le mock est vraiment limité car il vérifit l'appel, mais ne fournit aucune fonctionnalité...

## Objectif

Le but de ce TP est d'ajouter une gestion d'usagers à une application simple qui permet d'écrire des messages à propos de certains sujets (**Boards**).

En plus des **utilisateurs** normaux, vous devrez créer deux **rôles** pour gérer cette application:
- **Admin**
- **Moderator**

## Mettre en place Identity
- Ajout des packages pour Identity
- Ajout d'une classe ApplicationUser qui hérite de IdentityUser
- TODO: Ajouter les étapes

## Générez les pages Identity
- Scaffolding de Identity
- Ajouter les pages Razor
    app.MapRazorPages();
- Ajout du partial view de login à la page de navigation (Aligner a droite!)
- TODO: Ajouter les étapes

## Créer les liens avec ApplicationUser et faire un Seed

- Un **utilisateur** peut avoir un ou plusieurs **Messages**
- Modifiez le seed pour ajouter 3 utilisateurs: un administrateur, un modérateur et un utilisateur normal (avec les roles admin et moderator quand nécessaire)
- Associez les messages déjà existants à vos utilisateurs (chaque message d'un même Board doit être associé à un utilisateur différent)
- Modifiez la création de message pour qu'elle ne soit faisable que par un utilisateur et l'associé à son message
- Modifiez la création de sujets (Boards) pour que ce soit uniquement possible par un **Moderator**
- Affichez le nom de l'usager qui a écrit un message dans chaque message à côté de la date (ce nom deviendra clickable)

:::warning
Seeding du user necessite EmailConfirmed : true pour qu'il soit utilisable sans vérification du courriel.
:::

## Ajoutez le hard delete
- Les **Admins** et l'auteur d'un message (l'utilisateur associé au message) peuvent effacer un message complètement. Voici à quoi devrait ressembler la vue d'un message par son auteur:

![Image Reference](/tps/tp3/propreMessage.png)

- Et voici la vue d'un **Admin** (On va ajouter l'option Cacher très bientôt)

![Image Reference](/tps/tp3/messageNormalAdmin.png)

- Il faut donc afficher le message différement pour l'auteur et pour les Admins.
- Il ne faut pas oublier permettre **uniquement** aux admins et à l'auteur de faire cette action sur le serveur.

## Ajoutez l'option de cacher un message (soft delete)
- Les **Moderators** et les **Admins** peuvent cacher un message qui doi s'afficher comme ceci pour les usagers normaux lorsqu'il est caché:

![Image Reference](/tps/tp3/messageCache.png)

- Et comme ceci pour les **Moderators** qui peuvent cliquer sur Montrer pour l'afficher normalement à nouveau. Pour les **Admins** il faut afficher le bouton **Effacer** en plus.

![Image Reference](/tps/tp3/messageCacheModerateur.png)

![Image Reference](/tps/tp3/messageNormalModerateur.png)

- Il faut donc afficher les message différements pour les modérateurs également.
- Il ne faut pas oublier de permettre **uniquement** aux **Admins** et **Moderators** de faire cette action sur le serveur.


## Ajoutez une vue qui permet de voir les utilisateurs

![Image Reference](/tps/tp3/vueUtilisateursAdmin.png)

- Cette vue ne doit être accessible que par les **Admins**
- Ajoutez un lien dans la page de navigation
- Cette vue doit afficher chaque utilisateur avec l'information suivante:
    - Username
    - Email
    - S'il est admin ou pas
    - S'il est modérateur ou pas
    - S'il est banni ou pas
    - Les administrateurs doivent avoir la possibilité de changer les rôles des utilisateurs
    - Il faut également pouvoir bannir un utilisateur

## AJAX - Ajoutez une vue qui affiche les détails d'un utilisateur
- Cette vue est accessible par tout le monde en cliquant sur le courriel du user qui a rédigé un message:

![Image Reference](/tps/tp3/lienVueDetails.png)

- Elle s'affiche ainsi pour les utilisateurs normaux :

![Image Reference](/tps/tp3/vueDetailsUtilisateur.png)

- Et ainsi pour les **Moderators** et **Admins** :

![Image Reference](/tps/tp3/vueDetailsUtilisateurAdmin.png)

- Cette vue est une fenêtre modal
- Il faut utiliser un appel AJAX pour obtenir le contenu de cette **vue partielle**
- Cette vue permet également de bannir un usager pour les **Moderators** et **Admins**


## Les règles de sécurité:
### L'ensemble des actions qui peuvent être effectués par les utilisateurs selon leur rôle

- Sans être connecté, un usager peut voir les messages et voir les détails de l'**utilisateur** qui a publié un **Message**.
- Un usager connecté est considéré un **utilisateur**
- Un **utilisateur** peut envoyer des messages et effacer ses propres **Messages** (de façon permanente).
- Un **moderator** peut voir la liste des **utilisateurs**.
- Un **moderator** peut créer une nouveau **Board**.
- Un **moderator** peut **cacher** un **message** (soft delete) ou le réafficher.
    Lorsqu'un **message** est **caché**, il n'est plus visible sauf par des **utilisateurs** avec un rôle **Admin** ou **Moderator** qui peuvent également le réafficher. [Pas de confirmation]
- **Moderator** peut bannir un usager, sauf si l'utilisateur a un rôle **Admin** ou **Moderator**.
- **Admin** peut tout faire ce que **Moderator** peut faire, incluant **cacher** un **message**, mais aussi l'**effacer** de façon permanente comme si c'était l'**utilisateur** qui a écrit le **message**. Il peut **bannir** un utilisateur et ce peu importe le **Role** de l'**utilisateur**.
- **Admin** peut donner les droits **Moderator** et **Admin** ou les retirer.
- Protection contre les erreurs. Un **utilisateur** ne peut pas se bannir lui même et il ne peut pas se retirer les droits **admin**! (pour faire simple, on peut dire qu'un **utilisateur** ne peut pas modifier ses propres **roles**)
- Un **utilisateur** **banni** ne peut faire aucune action qu'un **utilisateur** peut faire normalement (Il n'y a que les fonctions qui sont accessibles sans connection qui restent accessible)
- Il n'est pas interdit qu'un utilisateur soit à la fois un **Moderator** et un **Admin**, mais si c'est le cas, il doit se comporter de la même façon qu'un **Admin**


Déjà fait à l'avance:
- Création d'un projet MVC
- Création de la classe Message
- Création de la classe Board
- Création d'une première migration qui va créer le DBContext
- Affichage de boards avec ordre par index
- Affichage de messages (username et date) [order by timestamp]
- Seeding de boards et messages

À faire:

- Ajouter un username à choisir au login (doit être unique)
- Afficher le username et non le email dans le menu de login

- Afficher le bouton delete quand l'utilisateur est un Moderator


## Grille de correction

| Tâche | Nb Points |
| :--- | :----: |
| T1 | x |
| **Total** | **/15** |
